rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // İstifadəçilər (users) kolleksiyası üçün qaydalar
    match /users/{userId} {
      allow read, update, create: if request.auth != null && request.auth.uid == userId;
    }

    // Businesses kolleksiyası üçün qaydalar
    match /artifacts/{projectId}/public/data/businesses/{businessId} {
      // Heç kəs oxuya bilməz
      allow read: if false;

      // Yalnız daxil olmuş istifadəçilər və status 'pending' olduqda create edə bilər
      allow create: if request.auth != null && request.resource.data.status == 'pending';

      // Update və delete icazəsi verilmir
      allow update, delete: if false;
    }

    // Orders kolleksiyası üçün qaydalar
    match /artifacts/{projectId}/public/data/orders/{orderId} {
      // İstifadəçi yalnız öz sifarişini oxuya bilər
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;

      // Daxil olmuş istənilən istifadəçi create edə bilər
      allow create: if request.auth != null;

      // isNew sahəsini yeniləmək üçün icazə (yalnız sahə `isNew` dəyişə bilər)
      allow update: if request.auth != null &&
                    request.auth.uid == resource.data.userId &&
                    request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isNew']);

      // Admin istifadəçilər update və delete edə bilər
      allow update, delete: if request.auth != null &&
                            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // Rəqəmsal Məhsul Sifarişləri (digital_product_orders)
    match /artifacts/{projectId}/public/data/digital_product_orders/{orderId} {
      // Yalnız sahib istifadəçi oxuya bilər
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;

      // Hər hansı daxil olmuş istifadəçi create edə bilər
      allow create: if request.auth !=null;

      // Yalnız adminlər update və delete edə bilər
      allow update, delete: if request.auth != null &&
                            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // İş Elanları (job_ads) üçün qaydalar
    match /artifacts/{projectId}/public/data/job_ads/{adId} {
      // Yalnız təsdiqlənmiş elanları oxumaq üçün icazə
      allow read: if request.auth != null && resource.data.approved == true;

      // Daxil olmuş istənilən istifadəçi elan yarada bilər (approved: false ilə)
      allow create: if request.auth != null && request.resource.data.approved == false;

      // Yalnız adminlər elanları təsdiqləyə, redaktə edə və silə bilər
      allow update, delete: if request.auth != null &&
                            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // Bütün digər yollara giriş qadağandır
    match /{document=**} {
      allow read, write: if false;
    }

  }
}
